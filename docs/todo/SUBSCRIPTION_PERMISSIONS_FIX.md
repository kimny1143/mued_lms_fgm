# サブスクリプション権限問題の恒久的な解決方法

本ドキュメントは、MUED LMSにおけるサブスクリプション情報取得に関する権限問題の恒久的な解決策を説明します。

## 問題概要

現在、ダッシュボードからサブスクリプション情報（プラン情報）を取得する際に、以下のエラーが発生しています：

1. `permission denied for schema public` - テーブルアクセス権限の問題
2. `Could not find the function public.get_subscription_by_user_id` - RPC関数が存在しない問題

これにより、サブスクリプションステータスがダッシュボードに正しく表示されず、「Free Plan」と誤って表示されています。

## 解決策

この問題は以下の3つのアプローチで恒久的に解決します：

1. **サーバーサイドAPIエンドポイント**: 管理者権限を使用してデータベースからサブスクリプション情報を安全に取得
2. **クライアントサイドフック**: APIエンドポイントを呼び出してサブスクリプション情報を取得
3. **RLSポリシーの修正**: ユーザーが自身のサブスクリプション情報を直接取得できるよう権限を設定

## 対応手順

### 1. データベース権限の修正

Supabaseダッシュボードでマイグレーションを実行するか、SQLエディタで以下のコマンドを実行してください：

```sql
-- マイグレーションファイル: supabase/migrations/20240512_fix_subscription_permissions.sql の内容を実行
```

### 2. APIエンドポイントの確認

プロジェクトルートにて、以下のファイルが存在するか確認してください：

- `/app/api/user/subscription/route.ts` - サブスクリプション情報取得API
- `/lib/auth.ts` - 認証ヘルパー関数

### 3. クライアントフックの確認

プロジェクトルートにて、以下のフックが正しく実装されているか確認してください：

- `/lib/hooks/use-subscription.ts` - サブスクリプション情報取得フック
- `/lib/hooks/use-user.ts` - ユーザー情報取得フック（サブスクリプションフックを利用）

### 4. アプリケーションの再起動

```bash
# 開発環境
npm run dev

# Docker環境
docker-compose restart
```

## 解決策の説明

### 1. サーバーサイドAPIエンドポイント

`/app/api/user/subscription/route.ts`では、サービスロール権限を持つ`supabaseAdmin`クライアントを使用してデータベースからサブスクリプション情報を取得します。これにより、クライアント側の権限に関係なく、常に正しいデータを取得できます。

### 2. クライアントサイドフック

`use-subscription.ts`フックは、APIエンドポイントを呼び出してサブスクリプション情報を取得します。一時的なエラーが発生した場合でも、60秒ごとに再試行するため、信頼性の高いデータ取得が可能です。

### 3. RLSポリシー

RLSポリシーを追加することで、通常のクライアントでもユーザー自身のサブスクリプション情報を直接取得できるようになります。さらに、RPC関数も追加されるため、SQL関数を通じたデータ取得も可能になります。

## テスト方法

1. ユーザーとしてログインし、ダッシュボードにアクセス
2. プラン情報が正しく表示されることを確認
3. ブラウザコンソールで以下のAPIが成功することを確認:
   ```javascript
   fetch('/api/user/subscription').then(r => r.json()).then(console.log)
   ```

## 今後の注意点

1. Supabaseスキーマを変更する際は、RLSポリシーも適切に設定すること
2. APIエンドポイントのセキュリティを定期的に確認すること
3. クライアントサイドでのデータ取得に失敗した場合のフォールバック処理を常に実装すること 