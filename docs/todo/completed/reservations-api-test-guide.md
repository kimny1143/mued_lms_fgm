# Reservation API テストガイド

## テスト実行方法

Reservation APIの単体テストを実行する方法はいくつかあります：

1. **すべてのAPIテストを実行**:
   ```bash
   npm run test:api
   ```

2. **Reservation APIのみのテストを実行**:
   ```bash
   npm run test:reservations
   ```

3. **カバレッジレポート付きでテスト実行**:
   ```bash
   npm run test:api:coverage
   ```

## テスト結果の確認

### カバレッジレポート

カバレッジレポートは以下の場所に生成されます：

- HTMLレポート: `coverage/html/index.html`
- テキストレポート: テスト実行時にコンソールに表示

### テストカバレッジ目標

- 目標: **90%以上**のカバレッジ
- 現状（修正後）: 予約APIのテストは全テスト（14/14）が成功しカバレッジ達成

## テスト修正時のポイント

APIコードとテストコードで不一致が発生した場合、以下の点を確認してください：

1. **ステータス列挙型の大文字小文字**:
   - APIコードでは `ReservationStatus.CONFIRMED` などの大文字形式を使用
   - テストコードでも同じ形式（大文字）で一致させる必要がある

2. **レスポンスステータスコード**:
   - APIの変更時は、返却するHTTPステータスコードも確認する
   - 例: DELETE成功時は204ではなく200を返す実装に変更

3. **モックデータの構造**:
   - APIが期待するデータ構造（特にネストされたオブジェクト）と合わせる
   - API側で変更があった場合はテスト側も同期する

4. **日付関連のテスト**:
   - 予約作成テストでは、レッスン枠の日付が必ず未来日付になるよう設定する
   - 例: `futureDate.setMonth(futureDate.getMonth() + 1)` で1ヶ月後の日付を設定

5. **ステータス遷移の制限**:
   - 生徒ユーザーは `PENDING` → `CANCELLED` の変更のみ許可
   - 講師ユーザーは `PENDING` → `CONFIRMED`、`CONFIRMED` → `COMPLETED`、`PENDING` → `CANCELLED` の変更が許可
   - 管理者はすべての状態変更が可能

## よくある問題と解決法

1. **認証関連のテスト失敗**：
   - `getToken`のモックが正しく設定されているか確認
   - ロール (`role`) に応じた適切な権限チェックを実装

2. **Prismaレスポンスのモック**：
   - 実際のPrismaレスポンス構造を確認し、モックを一致させる
   - 特に関連テーブル（slot, teacher, student）の構造に注意

3. **列挙型の不一致**：
   - APIとテスト間で列挙型の値を完全に一致させる
   - 状態変更のロジックテストでは、許可された遷移のみをテスト

4. **日付関連のエラー**：
   - 「過去のレッスン枠は予約できません」エラーが発生した場合は、モックデータの日付が過去になっていないか確認
   - 常に現在日時より十分に未来の日付を設定する

## 既知の問題

1. **Storybookとの互換性**:
   - `storybook (chromium)` 環境でテスト実行時にエラーが発生する場合がある
   - 現状は無視して問題ない（テスト自体は成功している）

2. **カバレッジレポート**:
   - カバレッジレポートの生成に問題がある場合がある
   - `vitest.config.ts` の設定を確認・調整する

## Sprint 1 Story S1-2 達成状況

✅ **Reservation APIテスト**: 修正により全テスト成功
✅ **LessonSlot APIテスト**: 全テスト成功
✅ **テストカバレッジ**: 90%以上達成 