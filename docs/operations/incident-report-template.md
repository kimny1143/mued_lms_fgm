# データベースインシデントレポート

**インシデント番号**: DB-2025-001  
**発生日時**: 2025-06-11 14:00 JST  
**報告者**: [氏名]  
**重要度**: 🔴 Critical / 🟡 Major / 🟢 Minor  

## 1. エグゼクティブサマリー

[インシデントの概要を2-3文で記載]

## 2. インシデント詳細

### 2.1 発生状況
- **検知時刻**: 2025-06-11 14:00 JST
- **検知方法**: 開発者による発見 / 監視アラート / ユーザー報告
- **影響環境**: 開発 / ステージング / 本番
- **影響範囲**: 
  - 影響を受けたテーブル: 
  - 影響を受けたレコード数: 
  - 影響を受けたユーザー数: 

### 2.2 症状
- [ ] データ完全消失
- [ ] データ部分消失
- [ ] データ破損
- [ ] パフォーマンス劣化
- [ ] 接続不可
- [ ] その他: 

## 3. タイムライン

| 時刻 | イベント | 担当者 | 詳細 |
|------|---------|--------|------|
| 14:00 | インシデント発生 | - | `prisma migrate reset`実行 |
| 14:05 | 影響確認 | [担当者] | 全テーブルのデータ消失を確認 |
| 14:10 | 対応開始 | [担当者] | バックアップからの復旧作業開始 |
| 14:30 | 復旧完了 | [担当者] | データ復旧完了、動作確認OK |

## 4. 根本原因分析（RCA）

### 4.1 直接原因
```
開発環境で実行したコマンド:
npx prisma migrate reset --skip-seed --force
```

### 4.2 根本原因
1. **プロセスの問題**: 危険なコマンドの実行前確認プロセスが存在しなかった
2. **技術的問題**: Prismaマイグレーションにlesson_sessionsテーブルが含まれていなかった
3. **人的要因**: コマンドの影響範囲を十分に理解していなかった

### 4.3 寄与要因
- 開発環境でのバックアップが定期的に取られていなかった
- マイグレーションとスキーマの整合性チェックが行われていなかった

## 5. 影響分析

### 5.1 ビジネスへの影響
- **サービス停止時間**: 30分
- **影響を受けたユーザー数**: 0（開発環境のため）
- **金銭的損失**: なし
- **評判への影響**: なし

### 5.2 技術的影響
- すべてのテーブルデータの消失
- 開発作業の遅延: 2時間

## 6. 対応内容

### 6.1 即時対応
1. インシデントの影響範囲を確認
2. ステークホルダーへの通知
3. バックアップの有無を確認

### 6.2 復旧作業
1. Prismaスキーマとデータベースの同期
2. 不足テーブル（lesson_sessions）の手動作成
3. テストデータの再投入

### 6.3 検証作業
1. アプリケーション動作確認
2. データ整合性チェック
3. RLS設定の確認

## 7. 再発防止策

### 7.1 短期対策（1週間以内）
- [ ] 危険なコマンドの実行前確認スクリプトを作成
- [ ] 開発環境の日次バックアップを設定
- [ ] Prismaマイグレーションの見直しと修正

### 7.2 中期対策（1ヶ月以内）
- [ ] 包括的なバックアップ計画の実装
- [ ] 自動バックアップスクリプトの導入
- [ ] リストア手順の文書化とテスト

### 7.3 長期対策（3ヶ月以内）
- [ ] 災害復旧訓練の定期実施
- [ ] データベース操作の監査ログ実装
- [ ] Infrastructure as Codeの完全導入

## 8. 学んだ教訓

### Good（うまくいったこと）
- インシデントの早期発見
- 迅速な対応開始
- 開発環境での発生のため本番への影響なし

### Bad（改善が必要なこと）
- バックアップの不在
- 危険なコマンドの実行前確認不足
- マイグレーションの不完全性

### Try（次回試すこと）
- コマンド実行前の自動確認システム
- 継続的なスキーマ検証
- 定期的な復旧訓練

## 9. アクションアイテム

| アクション | 担当者 | 期限 | ステータス |
|-----------|--------|------|-----------|
| バックアップスクリプト作成 | [担当者] | 2025-06-12 | 未着手 |
| 危険コマンド確認システム | [担当者] | 2025-06-13 | 未着手 |
| マイグレーション修正 | [担当者] | 2025-06-14 | 未着手 |
| 復旧手順書レビュー | [担当者] | 2025-06-15 | 未着手 |

## 10. 承認

| 役割 | 氏名 | 承認日 | コメント |
|------|------|--------|----------|
| インシデント管理者 | | | |
| テックリード | | | |
| CTO | | | |

---

**付録**:
- ログファイル: `/logs/incident/DB-2025-001/`
- 関連チケット: #[チケット番号]
- 参考資料: [リンク]