# メンターブックカレンダー - マイグレーションガイド

このドキュメントでは、メンターブックカレンダー実装に関連するデータマイグレーションの手順について説明します。

## 固定時間枠（60-90分）マイグレーション

このマイグレーションは、すべてのレッスンスロットに対して固定時間制約（60-90分）を適用します。
既存の`minDuration`および`maxDuration`フィールドを更新し、60-90分の範囲に収まるようにします。

### 前提条件

- Node.js v18以上
- TypeScript 4.5以上
- 開発環境へのアクセス権限（データベースへの接続情報を含む）

### マイグレーション手順

1. プロジェクトのルートディレクトリに移動します。

```bash
cd mued_lms_fgm
```

2. 環境変数が適切に設定されていることを確認します。
必要に応じて`.env`ファイルをコピーして`.env.local`を作成し、データベース接続情報を設定します。

```bash
cp .env .env.local
# .env.localを編集してデータベース接続情報を設定
```

3. マイグレーションスクリプトを実行します。

```bash
npx ts-node prisma/migrations/data-migration-fixed-duration.ts
```

4. 出力されたログを確認し、マイグレーションが成功したことを確認します。
以下のようなメッセージが表示されるはずです：

```
固定時間枠 (60-90分) マイグレーションを開始します...
更新対象のレッスンスロット: XX件
XX/XX件を更新しました
全てのレコードの更新が完了しました
✅ 全てのレッスンスロットが固定時間制約 (60-90分) に更新されました
マイグレーションが成功しました
```

### トラブルシューティング

#### よくあるエラーと対処法

1. データベース接続エラー

```
Error: P1001: Can't reach database server at ...
```

対処法: `.env.local`ファイルのデータベース接続情報が正しいことを確認してください。
特に`DATABASE_URL`と`DIRECT_DATABASE_URL`の設定を確認します。

2. 権限エラー

```
Error: P1010: User does not have permissions to perform this action
```

対処法: 使用するデータベースユーザーが適切な権限を持っていることを確認してください。

3. 更新対象が多すぎる場合

更新対象のレッスンスロットが多い場合、処理に時間がかかる可能性があります。
その場合は、バッチサイズを小さくするか（デフォルト：100件）、サーバーでのバックグラウンド実行を検討してください。

### マイグレーション後の確認

1. 開発環境またはテスト環境で、メンターごとのレッスンスロット取得APIを呼び出し、
   返されるスロットが正しく`minDuration`と`maxDuration`の値を持っていることを確認します。

2. 予約作成フローをテストし、60-90分の時間枠制約が正しく適用されていることを確認します。

### 本番環境への適用

テスト環境での確認が完了したら、本番環境にマイグレーションを適用します。
本番環境では、メンテナンスウィンドウを設定し、ユーザーへの影響を最小限に抑えることをお勧めします。

```bash
# 本番環境での実行（例）
NODE_ENV=production npx ts-node prisma/migrations/data-migration-fixed-duration.ts
```

注意：本番環境への適用前に、必ずデータベースのバックアップを取得してください。 