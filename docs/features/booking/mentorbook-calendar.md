
# react-booking-calendarを用いたメンター単位カレンダー表示実装計画

基本は大事！！アーキテクト確認！！セキュリティUX！！

## プロジェクト概要

MUEDプラットフォーム上で、現在の予約システムを「メンター単位のカレンダー表示」に刷新し、Googleカレンダーのようなインターフェースを実現します。レッスン時間を60～90分に固定し、料金はレッスン時間に関わらず一定とします。将来的にはGoogleカレンダーとの連携も視野に入れた設計を行います。

## 選定ライブラリ

`@demark-pro/react-booking-calendar` を採用します。このライブラリは以下の特徴を持ちます：
- オーバーブッキング防止機能
- カスタマイズ性の高さ
- TypeScriptサポート
- アクティブな開発・メンテナンス状況

## 実装フェーズ・タイムライン

### フェーズ1：環境構築とライブラリ導入（3日間）

1. **ライブラリのインストールと基本設定**
   - `@demark-pro/react-booking-calendar`と関連依存関係のインストール
   - TailwindCSSとの互換性確認
   - 基本的なコンポーネント構造のセットアップ

2. **APIエンドポイント設計**
   - メンター情報取得APIの最適化
   - レッスンスロット取得APIの拡張（メンターIDでフィルタリング）
   - 予約作成APIの調整（時間固定の対応）

3. **データモデル拡張**
   - LessonSlotモデルに最小・最大時間制約の追加
   - 料金固定化のためのデータモデル調整

### フェーズ2：メンター単位カレンダー実装（5日間）

1. **メンター選択コンポーネント**
   - メンター一覧表示と選択機能
   - メンター詳細情報表示（プロフィール、レッスン内容概要）
   - アバター画像と評価表示

2. **カレンダーUI構築**
   - `@demark-pro/react-booking-calendar`のカスタマイズ
   - メンター単位の予約枠表示
   - 日付範囲ナビゲーション実装
   - 予約済み・利用可能スロットの視覚的区別

3. **レスポンシブデザイン対応**
   - モバイルデバイス向け最適化
   - タブレット・デスクトップ表示の調整
   - アクセシビリティ対応

### フェーズ3：予約システム改良（4日間）

1. **予約フローの刷新**
   - 時間枠選択機能（60分/90分選択UI）
   - 予約確認モーダルのデザイン改良
   - 料金計算ロジックの固定化（レッスン時間に関わらず一定）

2. **時間制約のバリデーション**
   - 60〜90分の時間枠制約実装
   - オーバーラップ防止ロジック
   - 予約可能時間の動的計算

3. **予約確認・キャンセル機能**
   - 予約確認メール送信システムの連携
   - キャンセルポリシーの実装
   - 再予約フローの最適化

### フェーズ4：決済連携とテスト（3日間）

1. **決済フローとの統合**
   - Stripe決済プロセスとの連携調整
   - 固定料金での決済処理
   - 予約確定後のフィードバック表示

2. **テストとデバッグ**
   - ユニットテスト実装
   - 統合テストシナリオ構築
   - エッジケースの検証とバグ修正

3. **パフォーマンス最適化**
   - レンダリング効率の改善
   - API呼び出しの最適化
   - キャッシング戦略の実装

### フェーズ5：Googleカレンダー連携準備（5日間）

1. **Google API設定**
   - Google Developer Consoleでのプロジェクト設定
   - 必要なAPIキーとスコープの設定
   - OAuth認証フロー設計

2. **カレンダーイベント同期機能**
   - 予約作成時のGoogleカレンダーイベント登録
   - イベント更新・キャンセル時の同期処理
   - 定期的な同期バッチ処理の設計

3. **UI統合とテスト**
   - Googleカレンダー連携設定UI
   - 同期状態表示の実装
   - エラーハンドリングと再試行メカニズム

## 具体的な実装TODO

### フェーズ1：環境構築とライブラリ導入

```plaintext
[日程: 1日目]
✅ ライブラリのインストール
 ✅ react-booking-calendar及び依存パッケージのインストール
 ✅-TypeScript型定義ファイルの確認
✅ 基本設定ファイルの作成
 ✅ カレンダー表示の基本設定（テーマ、表示オプション）
 ✅ TailwindCSSとの互換性確認

[日程: 2日目]
✅ APIエンドポイント設計
 ✅ メンター情報取得APIの拡張設計
 ✅ レッスンスロット取得APIに絞り込み機能追加
 ✅ 予約作成APIの仕様調整（固定時間対応）
✅ データモデル設計書作成
 ✅ LessonSlotモデルの拡張設計
 ✅ Reservationモデルの調整設計

[日程: 3日目]
✅ APIエンドポイント実装
 ✅ GET /api/mentors の実装・拡張
 ✅ GET /api/lesson-slots/{mentorId} の実装
 ✅ POST /api/reservations の修正実装
✅ データマイグレーション計画策定
 ✅ 既存データとの互換性確保
 ✅ マイグレーションスクリプト作成
```

### フェーズ2：メンター単位カレンダー実装

```plaintext
[日程: 4日目]
✅ メンター選択コンポーネント実装
 ✅ MentorList.tsx の作成
 ✅ MentorCard.tsx の作成
 ✅ メンター選択状態管理の実装

[日程: 5-6日目]
✅ カレンダーコンポーネント実装
 ✅ MentorCalendar.tsx の作成
 ✅ react-booking-calendarの統合
 ✅ 予約可能スロットのスタイリング
 ✅ 日付範囲ナビゲーションの実装

[日程: 7-8日目]
✅ レスポンシブデザイン実装
 ✅ モバイル表示最適化
 ✅ タブレット・デスクトップ表示の最適化
 ✅ アクセシビリティ対応（キーボードナビゲーション、スクリーンリーダー対応）
✅ 状態管理ロジック実装
 ✅ カレンダー状態の管理（選択日付、表示範囲）
 ✅ メンター選択状態との連携
```

### フェーズ3：予約システム改良

```plaintext
[日程: 9-10日目]
□ 予約フロー実装
 - 時間枠選択UIの実装（60/90分選択）
 - TimeSlotSelector.tsx の作成
 - ReservationModal.tsx の改修

[日程: 11日目]
□ 時間制約バリデーション実装
 - 60〜90分制約のロジック実装
 - 予約可能時間の計算ロジック実装
 - バリデーションエラー表示の実装

[日程: 12日目]
□ 予約確認・管理機能実装
 - 予約確認画面の実装
 - キャンセルフローの実装
 - マイ予約一覧画面の改良
```

### フェーズ4：決済連携とテスト

```plaintext
[日程: 13日目]
□ 決済フロー連携
 - 固定料金での決済処理実装
 - Stripe連携の調整
 - 決済完了後のリダイレクト処理

[日程: 14日目]
□ テスト実装
 - ユニットテスト作成
 - 統合テストシナリオ作成
 - 手動テスト計画策定

[日程: 15日目]
□ パフォーマンス最適化
 - レンダリング効率改善
 - API呼び出し最適化
 - キャッシング実装
□ デバッグと修正
 - 発見された問題の修正
 - エッジケースの検証
```

### フェーズ5：Googleカレンダー連携準備

```plaintext
[日程: 16-17日目]
□ Google API設定
 - Google Developer Consoleでのプロジェクト設定
 - 必要なAPIキーとクライアントID取得
 - OAuth認証フローの設計と実装

[日程: 18-19日目]
□ カレンダー同期機能実装
 - GoogleCalendarService.ts の作成
 - 予約イベントのGoogleカレンダー登録機能
 - イベント更新・キャンセル時の同期処理

[日程: 20日目]
□ UI統合とテスト
 - Googleカレンダー連携設定UIの作成
 - 連携状態表示の実装
 - エラーハンドリングと再試行機能
□ ドキュメンテーション
 - 実装の技術ドキュメント作成
 - ユーザーガイド作成
```

## 技術的検討事項

### データ構造

```typescript
// メンター情報
interface Mentor {
  id: string;
  name: string;
  email: string;
  image?: string;
  bio?: string;
  hourlyRate: number;
  availability?: TimeSlot[];
}

// 予約可能時間枠
interface TimeSlot {
  id: string;
  mentorId: string;
  startTime: Date;
  endTime: Date;
  isAvailable: boolean;
}

// 予約情報
interface Reservation {
  id: string;
  slotId: string;
  userId: string;
  duration: number; // 60または90分
  startTime: Date;
  endTime: Date;
  status: 'pending' | 'confirmed' | 'canceled' | 'completed';
  paymentId?: string;
  googleCalendarEventId?: string;
}
```

### APIエンドポイント設計

```typescript
// メンター一覧取得
GET /api/mentors

// 特定メンターの予約可能枠取得
GET /api/mentors/:mentorId/availability?from=2024-05-01&to=2024-05-31

// 予約作成
POST /api/reservations
{
  "slotId": "slot123",
  "duration": 60,
  "startTime": "2024-05-15T14:00:00Z"
}

// Googleカレンダー連携設定
POST /api/users/me/google-calendar
{
  "accessToken": "...",
  "refreshToken": "..."
}
```

## リスクと対策

1. **予約衝突リスク**
   - 対策：楽観的ロックの実装、予約前の最終確認

2. **UIパフォーマンス**
   - 対策：仮想化リスト、ページネーション、適切なキャッシング

3. **Googleカレンダー連携の複雑さ**
   - 対策：段階的実装、エラーハンドリングの強化

4. **ユーザビリティ課題**
   - 対策：早期ユーザーテスト、段階的なUI改善

---

この実装計画に基づいてプロジェクトを進めることで、メンター単位のカレンダー表示と固定時間・固定料金の予約システムを効率的に構築できます。各フェーズごとにテストとレビューを行い、品質を確保しながら開発を進めていきます。
