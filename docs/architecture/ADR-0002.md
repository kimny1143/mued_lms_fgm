# ADR-0002: API バージョニングとエラーフォーマットの標準化

## ステータス

- [x] 提案
- [x] 承認
- [ ] 実装済み
- [ ] 非推奨
- [ ] 廃止

## コンテキスト

MUED LMSプロジェクトには複数のマイクロサービスが存在し、それぞれのサービス間で一貫性のあるAPI通信が必要です。特に：

- フロントエンド（Vite + React）とAIサービス（FastAPI）間の通信
- 将来的なマイクロサービスの追加
- APIの進化に伴うバージョン管理
- エラーレスポンスの標準化によるクライアント側での一貫したエラーハンドリング

現在は各サービスが独自のエラー形式を使用しており、またバージョニング戦略も明確に定められていません。

## 決定

以下の標準を採用します：

### 1. APIバージョニング

- **URL内のバージョン表記**: `/api/v1/resource` 形式を使用
- **バージョン命名法**: `v{major}` 形式（例: v1, v2）
- **バージョン更新基準**:
  - 破壊的変更がある場合にメジャーバージョンを上げる
  - 既存のバージョンは一定期間（最低6ヶ月）は維持する

### 2. 標準エラーフォーマット

すべてのAPIレスポンスは以下のフォーマットに従います：

```json
{
  "success": boolean,
  "data": any | null,
  "error": {
    "code": string,
    "message": string,
    "details": any | null
  } | null
}
```

- 成功時は `success: true` とし、`data` フィールドに結果を含める
- エラー時は `success: false` とし、`error` オブジェクトに詳細を含める
- ステータスコードは HTTP ステータスコードと一致させる

### 3. エラーコード体系

エラーコードは以下の形式に従います：
`{service_prefix}_{error_category}_{specific_error}`

例：
- `AUTH_VALIDATION_INVALID_CREDENTIALS`
- `CORE_NOT_FOUND_USER`
- `AI_PROCESSING_MODEL_FAILED`

## 理由

1. **APIバージョニング**
   - URLパスでのバージョニングは実装が簡単で、クライアント側の理解が容易
   - メジャーバージョンの更新のみを行うことで、APIの進化と後方互換性のバランスを取る

2. **標準エラーフォーマット**
   - 一貫した構造により、クライアント側での処理が簡素化される
   - エラーに関する詳細情報を提供することで、デバッグが容易になる
   - サービス間で統一されたエラー処理パターンを実現

3. **エラーコード体系**
   - エラーの発生元と種類を明確に区別可能
   - 階層構造により、エラーの分類とフィルタリングが容易になる
   - 国際化（i18n）対応の基盤となる

## 影響

- 既存のFastAPIサービスは、標準エラーフォーマットに対応するための変更が必要
- フロントエンドのAPIクライアントは、新しいエラーハンドリングパターンに更新する必要がある
- 全てのAPI呼び出しでレスポンス構造の検証が必要になる

## 関連リンク

- [FastAPI Exception Handling](https://fastapi.tiangolo.com/tutorial/handling-errors/)
- [RESTful API Design: Best Practices](https://swagger.io/resources/articles/best-practices-in-api-design/)

---

## メタデータ

- 作成日: 2024-05-01
- 作成者: 山田
- レビュアー: チーム全体
- 最終更新: 2024-05-01 